<!DOCTYPE html>
<html>
<link rel="stylesheet" type="text/css" href="style.css">
<body bgcolor="#282C34" text="#ABB2BF">
	<select id="portList" style="width:100px; height:20px;"></select>
    <button id="refresh" class="myButton" type="button" onclick="doRefresh()">
	  <img src="./icon/0133-spinner11.png">
	</button>
	<select id="baudRate" style="width:100px; height:20px;">
		<option value="115200">115200</option>
		<option value="57600">57600</option>
		<option value="38400">38400</option>
		<option value="19200">19200</option>
		<option value="9600">9600</option>
		<option value="4800">4800</option>
		<option value="2400">2400</option>
		<option value="1800">1800</option>
	</select>
	<button id="toggle" class="myButton" type="button" onclick="toggle()">
	  &nbsp;&nbsp;Connect&nbsp;&nbsp;&nbsp;
	</button>
    <button id="lock" class="myButton" type="button" style="float: right; margin-left:5px;" onclick="scrollLock()">
	  &nbsp;&nbsp;&nbsp;Lock&nbsp;&nbsp;<img src="./icon/rsz_0071-pushpin.png">
	</button>
    <button id="clear" class="myButton" type="button" style="float: right;  margin-left:5px;" onclick="doClear()">
	  &nbsp;&nbsp;&nbsp;Clear&nbsp;&nbsp;<img src="./icon/0173-bin.png">
	</button>
<script>   
	var isLocked = 0;
	var isConnected = 0;
	
	var SerialPortLib = require("serialport");
	var SerialPort = SerialPortLib.SerialPort;
	var sPort;
	var frame = parent.frames["log_view_frame"];
	
	document.getElementById("toggle").disabled = true;
			
	doRefresh();

	function addPortNum(portNum) {
		var port = document.createElement("option");
		port.setAttribute("value", portNum);
		var t = document.createTextNode(portNum);
		port.appendChild(t);
		document.getElementById("portList").appendChild(port);
	}
	
    function clearPortList() {
        var list = document.getElementById("portList");
        for(i=0; i<list.length; i++) {
            list.remove(i);
        }
    }
    
    function doRefresh() {
        clearPortList();
        SerialPortLib.list(function (err, ports) {
            ports.forEach(function(port) {
                addPortNum(port.comName);
                document.getElementById("toggle").disabled = false;
            });
        });
    }

	function doConnect(port, rate) {
		sPort = new SerialPort("\\\\.\\" + port, 
		{ baudrate: rate }, false); 
		
		sPort.open(function (error) {
			if ( error ) {
				alert(error);
			} else {
				sPort.on('data', function(data) {
					var logView = frame.document.getElementById("logView");
					var str = "" + data;
					var lastChar = str.slice(-1);
					
					if(str.includes("\n")) {
						var strArr = str.split("\n");
						for(i=0; i<strArr.length-1; i++) {
							logView.appendChild(document.createTextNode(strArr[i]));
							logView.appendChild(document.createElement('br'));
						}
						logView.appendChild(document.createTextNode(strArr[i]));
						if(lastChar == "\n") {
							logView.appendChild(document.createElement('br'));
						}
					} else {
						logView.appendChild(document.createTextNode(str));
					}
					
					if(isLocked == 0) {
						frame.scrollTo(0,frame.document.body.scrollHeight);
					}
				});
			}
		});
	}
	
	function doDisconnect() {
		sPort.close();
	}
	
	function toggle() {
		if (isConnected == 0) {
			isConnected = 1;
			document.getElementById("toggle").innerHTML = 'Disconnect';
            document.getElementById("refresh").disabled = true;
			document.getElementById("portList").disabled = true;
			document.getElementById("baudRate").disabled = true;
			doConnect(document.getElementById("portList").value, document.getElementById("baudRate").value);
		} else {
			isConnected = 0;
			document.getElementById("toggle").innerHTML = '&nbsp;&nbsp;Connect&nbsp;&nbsp;&nbsp;';
            document.getElementById("refresh").disabled = false;
			document.getElementById("portList").disabled = false;
			document.getElementById("baudRate").disabled = false;
			doDisconnect();
		}
	}
    
    function doClear() {
        var logView = frame.document.getElementById("logView");
        logView.innerHTML="";
    }
	
	function scrollLock() {
		if (isLocked == 0) {
			document.getElementById("lock").innerHTML = 
			'Unlock&nbsp;&nbsp;<img src=\"./icon/rsz_0071-pushpin.png\">';
			isLocked = 1;
		} else {
			document.getElementById("lock").innerHTML = 
			'&nbsp;&nbsp;&nbsp;Lock&nbsp;&nbsp;<img src=\"./icon/rsz_0071-pushpin.png\">';
			isLocked = 0;
		}
	}
</script>
</body>
</html>